<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>WebSocket Test</title>

<script src="deps/js/flatbuffers.js"></script>
<script src="aoc-state-reader/cpSchemaDef_generated.js"></script>

</head>
<body>
<script>

  //parse as an object or a primitive
  const parseUnknown = function(o) {
    if (typeof o == 'object') {
      if (o !== null) {
      return parseObject(o);
    } 
    return null;
      } else {
       return o;
    }
  }

  //iterate through, parsing fields as vectors etc
    const parseObject = function (o) {

        var out = {};
        var meths = Object.getOwnPropertyNames(o.__proto__);
        meths.forEach(function (f) {
            if (['constructor', '__init'].indexOf(f) > -1) {
                return;
            }
            if (f.substr(-6) == 'Length') {
                return;
            }

            if (meths.indexOf(f + 'Length') > -1) {
              var lName = f +'Length';
              var l = [];
              for (var i = 0; i < o[lName](); i++) {
                l.push(parseUnknown(o[f](i)));
              }
              out[f] = l;

            } else {
                out[f] = parseUnknown(o[f]());
            }

        });
        return out;
    }


var ws;

const allMessages = [];

const allObjects = {};

const objectOwner = {};


window.onload=function(){
  ws=new WebSocket("ws://localhost:8080/listen");
  ws.binaryType = 'arraybuffer';
  alert('Wow');
  
  ws.onmessage=function(evt){
    var d =  new Uint8Array(evt.data);
  	var buf = new flatbuffers.ByteBuffer(d);
  	var gm = AOC.GameMessage.getRootAsGameMessage(buf);
  	window.gm = gm;
    var o = parseObject(gm);
    console.log(o);
    allMessages.push(o);

    /* this tests for friendly fire
    o.objects.forEach(function(v, i){
      var all = v.buildings.concat(v.units);
      all.forEach(function(w){
        objectOwner[w.common.objectId] = i;
        allObjects[w.common.objectId] = w;
      });
    });

    o.damages.forEach(function(v){

      if (v.damagedId == 2330 && v.damageDone == 5) {
        console.log(v);
      }

      if (objectOwner[v.attackerId] === objectOwner[v.damagedId]) {
        if (allObjects[v.attackerId].common.objectType != 280) {
        console.warn(objectOwner[v.attackerId], v);
        console.log('Attacker: ', allObjects[v.attackerId]);
        console.log('Damaged: ', allObjects[v.damagedId]);
        }
      }

    });
*/
    //console.log(o.objects[1].buildings); 
    //console.log(o.objects[1].buildings[4].queue); 

    //console.log(o.objects[1].buildings[0].training); p1s tc training in most cases
  };
  ws.onopen=function(evt){

    var builder = new flatbuffers.Builder(64);

    //var restrictTo = AOC.ConfigMessage.createPlayerRestrictVVector(builder, [1,2]);

    AOC.ConfigMessage.startConfigMessage(builder);
    AOC.ConfigMessage.addTickInterval(builder, 1000);
    AOC.ConfigMessage.addPlayerRestriction(builder, AOC.Restriction.All);
    //AOC.ConfigMessage.addPlayerRestriction(builder, AOC.Restriction.InList);
    //AOC.ConfigMessage.addPlayerRestrictV(builder, restrictTo);

    AOC.ConfigMessage.addUpdateCycles(builder, 1);
    var cm = AOC.ConfigMessage.endConfigMessage(builder);
    builder.finish(cm);
    var buf = builder.asUint8Array();

    ws.send(buf);
  }
}
window.onclose=function(){
  ws.close();
}



</script>
</body>
</html>
